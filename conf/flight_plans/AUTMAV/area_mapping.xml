<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="1150" ground_alt="1000" lat0="35.728108" lon0="51.441201" max_dist_from_home="10000" name="Basic" security_height="10">
  <header>
    #include "subsystems/datalink/datalink.h"
    #include "modules/sensors/airspeed_ms45xx_i2c.h"
    #include "modules/autmav/catapult.h"
    #include "modules/autmav/advanced_landing.h"
    #include "modules/autmav/sony_camera_handler.h"
    #include "modules/autmav/survey.h"
    #include "firmwares/fixedwing/guidance/energy_ctrl_new.h"
    #include "firmwares/fixedwing/stabilization/stabilization_adaptive.h"
</header>
  <waypoints>
    <waypoint height="0.0" name="HOME" x="0.0" y="0.0"/>
    <waypoint height="50" name="AP" x="0.0" y="0.0"/>
    <waypoint height="50" name="TC" x="0.0" y="0.0"/>
    <waypoint height="50" name="TP" x="0.0" y="0.0"/>
    <waypoint name="TO" x="0.0" y="0.0"/>
    <waypoint name="CLIMB" x="0.0" y="0.0"/>
    <waypoint height="100.0" name="STDBY" x="0.0" y="0.0"/>
    <waypoint height="250.0" name="STDBY2" x="0.0" y="0.0"/>
    <waypoint height="400.0" name="STDBY3" x="0.0" y="0.0"/>
    <waypoint height="0.0" name="TD" x="0.0" y="0.0"/>
    <waypoint name="1" x="0.0" y="0.0"/>
    <waypoint name="2" x="0.0" y="0.0"/>
    <waypoint name="3" x="0.0" y="0.0"/>
    <waypoint name="4" x="0.0" y="0.0"/>
    <waypoint name="5" x="0.0" y="0.0"/>
    <waypoint name="6" x="0.0" y="0.0"/>
    <waypoint name="7" x="0.0" y="0.0"/>
    <waypoint name="8" x="0.0" y="0.0"/>
    <waypoint name="9" x="0.0" y="0.0"/>
    <waypoint name="10" x="0.0" y="0.0"/>
    <waypoint name="11" x="0.0" y="0.0"/>
    <waypoint name="12" x="0.0" y="0.0"/>
    <waypoint name="13" x="0.0" y="0.0"/>
    <waypoint name="14" x="0.0" y="0.0"/>
    <waypoint name="15" x="0.0" y="0.0"/>
    <waypoint name="16" x="0.0" y="0.0"/>
    <waypoint name="17" x="0.0" y="0.0"/>
    <waypoint name="18" x="0.0" y="0.0"/>
    <waypoint name="19" x="0.0" y="0.0"/>
    <waypoint name="20" x="0.0" y="0.0"/>
    <waypoint name="21" x="0.0" y="0.0"/>
    <waypoint name="22" x="0.0" y="0.0"/>
    <waypoint name="23" x="0.0" y="0.0"/>
    <waypoint name="24" x="0.0" y="0.0"/>
    <waypoint name="25" x="0.0" y="0.0"/>
    <waypoint name="26" x="0.0" y="0.0"/>
    <waypoint name="27" x="0.0" y="0.0"/>
    <waypoint name="28" x="0.0" y="0.0"/>
    <waypoint name="29" x="0.0" y="0.0"/>
    <waypoint name="30" x="0.0" y="0.0"/>
    <waypoint name="31" x="0.0" y="0.0"/>
    <waypoint name="32" x="0.0" y="0.0"/>
    <waypoint name="33" x="0.0" y="0.0"/>
    <waypoint name="34" x="0.0" y="0.0"/>
    <waypoint name="35" x="0.0" y="0.0"/>
    <waypoint name="36" x="0.0" y="0.0"/>
    <waypoint name="37" x="0.0" y="0.0"/>
    <waypoint name="38" x="0.0" y="0.0"/>
    <waypoint name="39" x="0.0" y="0.0"/>
    <waypoint name="40" x="0.0" y="0.0"/>
    <waypoint name="41" x="0.0" y="0.0"/>
    <waypoint name="42" x="0.0" y="0.0"/>
    <waypoint name="43" x="0.0" y="0.0"/>
    <waypoint name="44" x="0.0" y="0.0"/>
    <waypoint name="45" x="0.0" y="0.0"/>
    <waypoint name="46" x="0.0" y="0.0"/>
    <waypoint name="47" x="0.0" y="0.0"/>
    <waypoint name="48" x="0.0" y="0.0"/>
    <waypoint name="49" x="0.0" y="0.0"/>
    <waypoint name="50" x="0.0" y="0.0"/>
    <waypoint name="51" x="0.0" y="0.0"/>
    <waypoint name="52" x="0.0" y="0.0"/>
    <waypoint name="53" x="0.0" y="0.0"/>
    <waypoint name="54" x="0.0" y="0.0"/>
    <waypoint name="55" x="0.0" y="0.0"/>
    <waypoint name="56" x="0.0" y="0.0"/>
    <waypoint name="57" x="0.0" y="0.0"/>
    <waypoint name="58" x="0.0" y="0.0"/>
    <waypoint name="59" x="0.0" y="0.0"/>
    <waypoint name="60" x="0.0" y="0.0"/>
    <waypoint name="61" x="0.0" y="0.0"/>
    <waypoint name="62" x="0.0" y="0.0"/>
    <waypoint name="63" x="0.0" y="0.0"/>
    <waypoint name="64" x="0.0" y="0.0"/>
    <waypoint name="65" x="0.0" y="0.0"/>
    <waypoint name="66" x="0.0" y="0.0"/>
    <waypoint name="67" x="0.0" y="0.0"/>
    <waypoint name="68" x="0.0" y="0.0"/>
    <waypoint name="69" x="0.0" y="0.0"/>
    <waypoint name="70" x="0.0" y="0.0"/>
    <waypoint name="71" x="0.0" y="0.0"/>
    <waypoint name="72" x="0.0" y="0.0"/>
    <waypoint name="73" x="0.0" y="0.0"/>
    <waypoint name="74" x="0.0" y="0.0"/>
    <waypoint name="75" x="0.0" y="0.0"/>
    <waypoint name="76" x="0.0" y="0.0"/>
    <waypoint name="77" x="0.0" y="0.0"/>
    <waypoint name="78" x="0.0" y="0.0"/>
    <waypoint name="79" x="0.0" y="0.0"/>
    <waypoint name="80" x="0.0" y="0.0"/>
    <waypoint name="81" x="0.0" y="0.0"/>
    <waypoint name="82" x="0.0" y="0.0"/>
    <waypoint name="83" x="0.0" y="0.0"/>
    <waypoint name="84" x="0.0" y="0.0"/>
    <waypoint name="85" x="0.0" y="0.0"/>
    <waypoint name="86" x="0.0" y="0.0"/>
    <waypoint name="87" x="0.0" y="0.0"/>
    <waypoint name="88" x="0.0" y="0.0"/>
    <waypoint name="89" x="0.0" y="0.0"/>
    <waypoint name="90" x="0.0" y="0.0"/>
    <waypoint name="91" x="0.0" y="0.0"/>
    <waypoint name="92" x="0.0" y="0.0"/>
    <waypoint name="93" x="0.0" y="0.0"/>
    <waypoint name="94" x="0.0" y="0.0"/>
    <waypoint name="95" x="0.0" y="0.0"/>
    <waypoint name="96" x="0.0" y="0.0"/>
    <waypoint name="97" x="0.0" y="0.0"/>
    <waypoint name="98" x="0.0" y="0.0"/>
    <waypoint name="99" x="0.0" y="0.0"/>
    <waypoint name="100" x="0.0" y="0.0"/>
 </waypoints>
  <exceptions>
    <!--exception cond="datalink_failsafe()" deroute="Loiter"/>
    <exception cond="max_distance_failsafe()" deroute="Loiter"/-->
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <set value="50" var="nav_radius"/>
      <set value="1" var="autopilot.kill_throttle"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 10)"/>
      <call fun="NavSetGroundReferenceHere()"/>
      <call fun="NavSetAltitudeReferenceHere()"/>
    </block>
    <block name="Airspeed calibration" strip_button="Calibration">
      <set value="(ms45xx.pressure_offset + ms45xx.diff_pressure)" var="ms45xx.pressure_offset"/>
      <deroute block="Holding point"/>
    </block>
    <block name="Clear Mission" strip_button="ClearMission">
      <call_once fun="clean_current_mission()"/>
      <call_once fun="initialize_mission_vars()"/>  
    </block>    
    <block name="Holding point">
      <set value="1" var="autopilot.kill_throttle"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    <block name="Arm Catapult" strip_button="Takeoff">
      <exception cond="GetPosAlt() > GetAltRef()+30" deroute="Disarm Catapult"/>
      <call_once fun="v_ctl_initialize_variables()"/>
      <call_once fun="h_ctl_initialize_variables()"/>
      <call_once fun="set_sf11_agl_mode(false)" />
      <call_once fun="set_rtk_passthrough_agl(false)" />
      <set value="0" var="autopilot.kill_throttle"/>
      <call fun="nav_catapult_setup()"/>
      <call fun="nav_catapult_run(WP_TO, WP_CLIMB)"/>
    </block>
    <block name="Disarm Catapult">
      <call fun="nav_catapult_disarm()"/>
      <deroute block="Standby"/>
    </block>
    <block name="Standby">
      <circle radius="nav_radius" wp="STDBY"/>
    </block>
    <block name="Standby2">
      <circle radius="nav_radius" wp="STDBY2"/>
    </block>
    <block name="Standby3">
      <circle radius="nav_radius" wp="50"/>
    </block>
    <block name="Climb" strip_button="Survey" strip_icon="survey.png">
      <circle wp="STDBY" vmode="climb" climb="3.0" radius="nav_radius" until=" GetPosAlt() > WaypointAlt(WP_1)"/>
    </block>
    <block name="Survey">
      <call fun="nav_survey_photo_run()"/>
      <deroute block="Standby"/>
    </block>

	<block name="Loiter" strip_button="Landing">
		<go wp="TD" vmode="alt" alt="GetPosAlt()"/>
		<circle wp="TD" radius="nav_radius" vmode="climb" climb="-3.0" until="70 > (GetPosAlt() - GetAltRef())"/>
	    <call_once fun="calc_turning_point(WP_TD, WP_AP, WP_TP, WP_TC)" />
		<circle wp="TD" radius="nav_radius" vmode="alt" alt="50 + ground_alt" until="NavCourseCloseTo(nav_advanced_landing_direction)" />
	</block>

	<block name="Approach">
		<go wp="TP" vmode="alt"/>
		<circle wp="TC" radius="nav_radius" vmode="alt" until="NavCircleCount() > 0.5" />
		<call_once fun="set_sf11_agl_mode(false)" />
        <call_once fun="set_rtk_passthrough_agl(true)" />
	</block>

	<block name="Landing">
		<go from="AP" hmode="route" vmode="glide" wp="TD" approaching_time="nav_advanced_landing_flair_time_tresh"/>
	</block>

	<block name="flare">
      <exception cond="LessThan(10 ,NavBlockTime())" deroute="Holding point"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
	</block>
	
  </blocks>
</flight_plan>
